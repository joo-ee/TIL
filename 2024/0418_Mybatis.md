### Mybatis timeout !

어제까지 잘만 되던 거래처 정보 관련 엑셀 다운로드 기능이 오늘 오전부터 Timeout 에러가 발생했다 🙄 얼마 전에 내가 수정했던 부분이라 내 잘못인 줄 알고 잔뜩 쫄았는데 그냥 데이터 건수가 너무 많아져서 발생했다는 ... 이야기 ...

~~근데 사실 어제에 비해 겨우 몇 백개 늘었을 뿐인데 타임아웃이 발생하는 정확한 이유는 아직 잘 모르겠다~~

#### #쿼리 타임아웃 설정이 필요한 이유는?

1! 장애 처리: 데이터베이스 서버가 응답하지 않는 경우, 쿼리가 영원히 실행되는 것을 방지하고 장애 상황을 처리하기 위해 타임아웃을 설정한다.

2! 리소스 제어: 장애 상황 또는 잘못된 쿼리로 인해 데이터베이스 연결이 계속 유지되는 것을 방지하기 위해 리소스 사용을 제어한다.

3! 성능 향상: 긴 지연 시간을 가진 쿼리로 인해 다른 사용자의 응답 시간이 느려지는 것을 방지하고 전체 시스템의 성능을 향상시킬 수 있다.

기본적으로 MyBatis에서 쿼리의 타임아웃이 설정되어 있지 않으면 데이터베이스에서 사용하는 기본 타임아웃이 적용되는데, 데이터베이스 제품에 따라 다를 수 있다. 보통은 몇 분에서 몇 시간까지 설정될 수 있다. 그러나 애플리케이션의 요구 사항에 따라 명시적으로 쿼리 타임아웃을 설정하는 것이 좋다고 하는데 ... 적절한 시간은 무엇인지 판단하는 게 어려운 일인 것 같다.

#### #Mybatis 쿼리 타임아웃을 설정하는 방법은?

1. 전역적으로 설정하는 방법 (mybatis-config.xml 파일에서)

```xml
<configuration>
    <settings>
        <!-- 전역 쿼리 타임아웃 설정 -->
        <setting name="defaultStatementTimeout" value="60"/>
        <!-- 타임아웃 시간: 30초 -->
    </settings>
</configuration>
```

2. 매퍼 XML 파일에서 개별적으로 설정하는 방법

```xml
<mapper namespace="com.example.mapper.MyMapper">
    <select id="selectUser" statementType="STATEMENT">
        <!-- 쿼리 타임아웃 설정 -->
        <statement timeout="10">
        <!-- 타임아웃 시간: 10초 -->
            SELECT * FROM users WHERE id = #{userId}
        </statement>
    </select>
</mapper>
```

개별적으로 설정한 값이 `defaultStatementTimeout` 으로 설정한 전역 쿼리 타임보다 우선시되지만, 사용하는 드라이버에 따라 지원되지 않을수도 있다고 한다.

결론적으로, 에러가 발생했던 원인은 데이터 건수가 많아지면서 쿼리 수행 시간이 200초 정도 되는데 defaultStatementTimeout 으로 60초 타임아웃 설정이 되어있기 때문이었다. DBA분과 검토 후에 문제가 된 쿼리만 개별적으로 600초로 타임아웃을 설정해서 임시 조치 완료! to be continued 인걸로 ...
